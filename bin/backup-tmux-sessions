#!/bin/bash
# Backup tmux session files to environmentConfigurator project
# These backups are git-tracked along with other environment configs

PROJECT_DIR="/mnt/c/Users/matt/PycharmProjects/environmentConfigurator"
BACKUP_DIR="$PROJECT_DIR/backups/tmux-sessions"
SOURCE_DIR="$HOME/.local/share/tmux/resurrect"
#
# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

# Check if source directory exists
if [ ! -d "$SOURCE_DIR" ]; then
    print_error "Source directory not found: $SOURCE_DIR"
    print_info "Tmux resurrect may not be initialized yet"
    exit 1
fi

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

print_info "Backing up tmux sessions..."
print_info "Source: $SOURCE_DIR"
print_info "Destination: $BACKUP_DIR"
echo ""

# Sync using rsync
if command -v rsync &> /dev/null; then
    rsync -av --delete "$SOURCE_DIR/" "$BACKUP_DIR/"
    exit_code=$?

    if [ $exit_code -eq 0 ]; then
        print_success "Backup complete!"

        # Show summary
        session_count=$(ls -1 "$BACKUP_DIR"/*.txt 2>/dev/null | wc -l)
        backup_size=$(du -sh "$BACKUP_DIR" | cut -f1)

        echo ""
        print_info "Snapshot files: $session_count"
        print_info "Total size: $backup_size"
        print_info "Latest: $(ls -t "$BACKUP_DIR"/*.txt 2>/dev/null | head -1 | xargs basename)"
        echo ""
        print_info "To commit: cd $PROJECT_DIR && ./bin/claude-config git-commit"
    else
        print_error "Backup failed with exit code: $exit_code"
        exit 1
    fi
else
    # Fallback to cp if rsync not available
    print_info "rsync not found, using cp..."
    cp -r "$SOURCE_DIR/"* "$BACKUP_DIR/"

    if [ $? -eq 0 ]; then
        print_success "Backup complete"
    else
        print_error "Backup failed"
        exit 1
    fi
fi
